# 效能測試指南

## 效能測試覆蓋範圍

Agent IDE 為以下核心模組建立了完整的效能基準測試：

1. **indexing** - 索引模組效能測試
2. **search** - 搜尋模組效能測試
3. **analysis** - 分析模組效能測試
4. **dependency** - 依賴模組效能測試
5. **rename** - 重新命名模組效能測試
6. **move** - 移動模組效能測試
7. **refactor** - 重構模組效能測試

## 效能測試類型分類

### 單元效能測試
- 單一操作執行時間測量
- 記憶體使用量監控
- 吞吐量計算
- 響應時間分析

### 整合效能測試
- 模組間協作效能
- 數據流處理速度
- 系統整體響應時間

### 負載效能測試
- 大量檔案處理能力 (1000+ 檔案)
- 並發操作測試
- 記憶體壓力測試
- 長時間運行穩定性

### 基準效能測試
- 回歸檢測
- 版本間比較
- 最佳化驗證

## 效能指標與基準

### 關鍵效能指標 (KPI)
- **索引速度**: > 1000 檔案/秒
- **搜尋延遲**: < 100ms (快取命中)
- **重構執行**: < 500ms (單檔案)
- **記憶體效率**: < 10MB/1000檔案
- **並發處理**: 支援 CPU 核心數 × 2 的並發操作

### 效能測試環境需求
- **記憶體**: 至少 4GB 可用記憶體
- **CPU**: 多核心處理器建議
- **磁碟**: SSD 建議，用於索引持久化測試
- **Node.js**: v20+ 以獲得最佳效能

## 執行效能測試

### 執行所有效能測試
```bash
pnpm test:performance
```

### 執行特定模組的效能測試
```bash
# 索引模組效能測試
pnpm test -- tests/performance/core/indexing

# 搜尋模組效能測試
pnpm test -- tests/performance/core/search
```

### 啟用效能輸出詳情
```bash
DEBUG_PERF=1 pnpm test:performance
```

## 效能測試最佳實踐

### 1. 測試隔離
- 每個測試應獨立執行，不依賴其他測試結果
- 清理測試產生的檔案和資源
- 使用獨立的測試目錄

### 2. 穩定性優先
- 避免使用過於嚴格的時間閾值
- 考慮環境因素（CI/本地差異）
- 使用相對比較而非絕對值

### 3. 結果記錄
- 記錄詳細的效能數據供分析
- 保留歷史數據以追蹤趨勢
- 產生效能報告供團隊檢視

### 4. 持續改進
- 定期檢視效能測試結果
- 識別效能瓶頸並優化
- 更新效能基準以反映實際需求

## 效能優化建議

### 快取策略
- 實作多層快取（記憶體/磁碟）
- 智能快取失效機制
- 預載入常用資料

### 並行處理
- 使用 Worker Threads 處理 CPU 密集任務
- 批次處理減少 I/O 開銷
- 非同步操作避免阻塞

### 記憶體管理
- 及時釋放不需要的資源
- 使用串流處理大檔案
- 實作記憶體池重用物件

## 問題診斷

### 常見效能問題
1. **索引速度慢**: 檢查檔案系統 I/O、Parser 效率
2. **搜尋延遲高**: 優化索引結構、增加快取
3. **記憶體洩漏**: 使用記憶體分析工具檢查
4. **並發瓶頸**: 調整 Worker 數量、優化鎖機制

### 效能分析工具
- Node.js 內建 profiler
- Chrome DevTools
- clinic.js
- 0x flame graph

## 相關資源
- [Vitest 效能測試文件](https://vitest.dev/guide/features.html#benchmarking)
- [Node.js 效能最佳實踐](https://nodejs.org/en/docs/guides/simple-profiling/)
- [效能測試結果儀表板](./performance-dashboard.md)（待建立）